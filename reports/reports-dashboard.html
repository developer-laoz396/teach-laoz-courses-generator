<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes Avanzados - Sistema Multi-Agente</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        h1 {
            font-size: 2em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .filters {
            background: #16213e;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 0.85em;
            color: #aaa;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: #1a1a2e;
            color: #eee;
            font-size: 0.95em;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            align-self: flex-end;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: #16213e;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        
        .card-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.03);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #aaa;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 400px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        th {
            background: rgba(102, 126, 234, 0.2);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background: rgba(255,255,255,0.03);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-success { background: #48bb78; color: white; }
        .badge-error { background: #f56565; color: white; }
        .badge-warning { background: #ed8936; color: white; }
        .badge-info { background: #4299e1; color: white; }
        
        .export-buttons {
            display: flex;
            gap: 10px;
        }
        
        .export-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: transparent;
            color: #667eea;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .export-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                 Reportes Avanzados
            </h1>
            <p>An谩lisis detallado de rendimiento y m茅tricas del sistema</p>
        </header>

        <div class="filters">
            <div class="filter-group">
                <label>Per铆odo</label>
                <select id="periodFilter">
                    <option value="all">Todo el tiempo</option>
                    <option value="7">ltimos 7 d铆as</option>
                    <option value="30" selected>ltimos 30 d铆as</option>
                    <option value="90">ltimos 90 d铆as</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Sesi贸n</label>
                <select id="sessionFilter">
                    <option value="all">Todas las sesiones</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Agente</label>
                <select id="agentFilter">
                    <option value="all">Todos los agentes</option>
                </select>
            </div>
            
            <button class="btn" onclick="loadReports()"> Actualizar</button>
            <button class="btn btn-secondary" onclick="exportAllData()"> Exportar Todo</button>
        </div>

        <!-- Resumen General -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <div class="card-title"> Resumen General</div>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalSessions">-</div>
                    <div class="stat-label">Total Sesiones</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCalls">-</div>
                    <div class="stat-label">Total Llamadas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="successRate">-</div>
                    <div class="stat-label">Tasa de xito</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalErrors">-</div>
                    <div class="stat-label">Total Errores</div>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Rendimiento por Agente -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Rendimiento por Agente</div>
                    <button class="export-btn" onclick="exportChart('agentPerformanceChart', 'rendimiento-agentes')"> Exportar</button>
                </div>
                <div class="chart-container">
                    <canvas id="agentPerformanceChart"></canvas>
                </div>
            </div>

            <!-- Distribuci贸n de Errores -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">锔 Distribuci贸n de Errores</div>
                    <button class="export-btn" onclick="exportChart('errorDistributionChart', 'distribucion-errores')"> Exportar</button>
                </div>
                <div class="chart-container">
                    <canvas id="errorDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Timeline de Ejecuciones -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">憋 Duraci贸n Promedio por Agente</div>
                    <button class="export-btn" onclick="exportChart('durationChart', 'duracion-agentes')"> Exportar</button>
                </div>
                <div class="chart-container">
                    <canvas id="durationChart"></canvas>
                </div>
            </div>

            <!-- Tendencia de Sesiones -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Tendencia de Sesiones</div>
                    <button class="export-btn" onclick="exportChart('sessionTrendChart', 'tendencia-sesiones')"> Exportar</button>
                </div>
                <div class="chart-container">
                    <canvas id="sessionTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tabla de Agentes -->
        <div class="card">
            <div class="card-header">
                <div class="card-title"> Detalle de Agentes</div>
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportTableToCSV('agentsTable', 'agentes')">CSV</button>
                    <button class="export-btn" onclick="exportTableToJSON('agentsTable', 'agentes')">JSON</button>
                </div>
            </div>
            <div class="table-container">
                <table id="agentsTable">
                    <thead>
                        <tr>
                            <th>Agente</th>
                            <th>Total Llamadas</th>
                            <th>Exitosas</th>
                            <th>Fallidas</th>
                            <th>Tasa xito</th>
                            <th>Duraci贸n Promedio</th>
                            <th>ltima Ejecuci贸n</th>
                        </tr>
                    </thead>
                    <tbody id="agentsTableBody">
                        <tr><td colspan="7" class="loading"><div class="spinner"></div>Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tabla de Errores Recientes -->
        <div class="card">
            <div class="card-header">
                <div class="card-title"> Errores y Warnings Recientes</div>
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportTableToCSV('errorsTable', 'errores')">CSV</button>
                    <button class="export-btn" onclick="exportTableToJSON('errorsTable', 'errores')">JSON</button>
                </div>
            </div>
            <div class="table-container">
                <table id="errorsTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Nivel</th>
                            <th>Mensaje</th>
                            <th>Agente</th>
                            <th>Fase</th>
                        </tr>
                    </thead>
                    <tbody id="errorsTableBody">
                        <tr><td colspan="5" class="loading"><div class="spinner"></div>Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001';
        let charts = {};
        let currentData = {};

        // Configuraci贸n de Chart.js
        Chart.defaults.color = '#eee';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';

        async function loadReports() {
            try {
                // Cargar datos
                const [summary, agents, errors, sessions] = await Promise.all([
                    fetch(`${API_URL}/api/metrics/summary`).then(r => r.json()),
                    fetch(`${API_URL}/api/agents`).then(r => r.json()),
                    fetch(`${API_URL}/api/reports/errors?limit=50`).then(r => r.json()),
                    fetch(`${API_URL}/api/sessions?limit=100`).then(r => r.json())
                ]);

                currentData = { summary: summary.data, agents: agents.data, errors: errors.data, sessions: sessions.data };

                // Actualizar resumen
                updateSummary(summary.data);

                // Actualizar filtros
                updateFilters(sessions.data, agents.data);

                // Actualizar gr谩ficos
                updateAgentPerformanceChart(agents.data);
                updateErrorDistributionChart(errors.data);
                updateDurationChart(agents.data);
                updateSessionTrendChart(sessions.data);

                // Actualizar tablas
                updateAgentsTable(agents.data);
                updateErrorsTable(errors.data.recent);

            } catch (error) {
                console.error('Error cargando reportes:', error);
                alert('Error cargando datos. Verifica que el servidor API est茅 corriendo.');
            }
        }

        function updateSummary(data) {
            document.getElementById('totalSessions').textContent = data.total_sessions || 0;
            document.getElementById('totalCalls').textContent = (data.total_agent_calls || 0).toLocaleString();
            
            const successRate = data.total_agent_calls > 0 
                ? Math.round((data.total_successful / data.total_agent_calls) * 100)
                : 100;
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('totalErrors').textContent = (data.total_errors || 0).toLocaleString();
        }

        function updateFilters(sessions, agents) {
            // Filtro de sesiones
            const sessionFilter = document.getElementById('sessionFilter');
            sessionFilter.innerHTML = '<option value="all">Todas las sesiones</option>';
            sessions.slice(0, 20).forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.id} (${new Date(s.start_time).toLocaleDateString()})`;
                sessionFilter.appendChild(option);
            });

            // Filtro de agentes
            const agentFilter = document.getElementById('agentFilter');
            agentFilter.innerHTML = '<option value="all">Todos los agentes</option>';
            agents.forEach(a => {
                const option = document.createElement('option');
                option.value = a.id;
                option.textContent = a.name;
                agentFilter.appendChild(option);
            });
        }

        function updateAgentPerformanceChart(agents) {
            const ctx = document.getElementById('agentPerformanceChart');
            
            if (charts.agentPerformance) {
                charts.agentPerformance.destroy();
            }

            const topAgents = agents.slice(0, 10);

            charts.agentPerformance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topAgents.map(a => a.name),
                    datasets: [{
                        label: 'Exitosas',
                        data: topAgents.map(a => a.successful_calls),
                        backgroundColor: 'rgba(72, 187, 120, 0.8)'
                    }, {
                        label: 'Fallidas',
                        data: topAgents.map(a => a.failed_calls),
                        backgroundColor: 'rgba(245, 101, 101, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    }
                }
            });
        }

        function updateErrorDistributionChart(errorData) {
            const ctx = document.getElementById('errorDistributionChart');
            
            if (charts.errorDistribution) {
                charts.errorDistribution.destroy();
            }

            const byAgent = errorData.by_agent || {};
            const topErrors = Object.entries(byAgent)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            charts.errorDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: topErrors.map(([agent]) => agent),
                    datasets: [{
                        data: topErrors.map(([, count]) => count),
                        backgroundColor: [
                            '#f56565', '#ed8936', '#ecc94b', '#48bb78',
                            '#38b2ac', '#4299e1', '#667eea', '#9f7aea'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        function updateDurationChart(agents) {
            const ctx = document.getElementById('durationChart');
            
            if (charts.duration) {
                charts.duration.destroy();
            }

            const topAgents = agents
                .filter(a => a.average_duration > 0)
                .sort((a, b) => b.average_duration - a.average_duration)
                .slice(0, 10);

            charts.duration = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: topAgents.map(a => a.name),
                    datasets: [{
                        label: 'Duraci贸n Promedio (ms)',
                        data: topAgents.map(a => a.average_duration),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }

        function updateSessionTrendChart(sessions) {
            const ctx = document.getElementById('sessionTrendChart');
            
            if (charts.sessionTrend) {
                charts.sessionTrend.destroy();
            }

            // Agrupar por d铆a
            const byDay = {};
            sessions.forEach(s => {
                const day = new Date(s.start_time).toLocaleDateString();
                byDay[day] = (byDay[day] || 0) + 1;
            });

            const sortedDays = Object.entries(byDay).sort((a, b) => new Date(a[0]) - new Date(b[0]));

            charts.sessionTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDays.map(([day]) => day),
                    datasets: [{
                        label: 'Sesiones por D铆a',
                        data: sortedDays.map(([, count]) => count),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateAgentsTable(agents) {
            const tbody = document.getElementById('agentsTableBody');
            tbody.innerHTML = agents.map(agent => `
                <tr>
                    <td><strong>${agent.name}</strong></td>
                    <td>${agent.total_calls}</td>
                    <td><span class="badge badge-success">${agent.successful_calls}</span></td>
                    <td><span class="badge badge-error">${agent.failed_calls}</span></td>
                    <td>${agent.success_rate ? agent.success_rate + '%' : '-'}</td>
                    <td>${agent.average_duration ? (agent.average_duration / 1000).toFixed(2) + 's' : '-'}</td>
                    <td>${agent.last_execution_time ? new Date(agent.last_execution_time).toLocaleString() : '-'}</td>
                </tr>
            `).join('');
        }

        function updateErrorsTable(errors) {
            const tbody = document.getElementById('errorsTableBody');
            tbody.innerHTML = errors.map(error => `
                <tr>
                    <td>${new Date(error.timestamp).toLocaleString()}</td>
                    <td><span class="badge badge-${error.level}">${error.level.toUpperCase()}</span></td>
                    <td>${error.message}</td>
                    <td>${error.agent_id || '-'}</td>
                    <td>${error.phase || '-'}</td>
                </tr>
            `).join('');
        }

        // Funciones de exportaci贸n
        function exportChart(chartId, filename) {
            const canvas = document.getElementById(chartId);
            const url = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `${filename}.png`;
            link.href = url;
            link.click();
        }

        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            let csv = [];
            
            // Headers
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
            csv.push(headers.join(','));
            
            // Rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => {
                    let text = td.textContent.trim();
                    return `"${text.replace(/"/g, '""')}"`;
                });
                csv.push(cells.join(','));
            });
            
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `${filename}.csv`;
            link.href = url;
            link.click();
        }

        function exportTableToJSON(tableId, filename) {
            const data = tableId === 'agentsTable' ? currentData.agents : currentData.errors.recent;
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `${filename}.json`;
            link.href = url;
            link.click();
        }

        function exportAllData() {
            const allData = {
                exported_at: new Date().toISOString(),
                summary: currentData.summary,
                agents: currentData.agents,
                errors: currentData.errors,
                sessions: currentData.sessions
            };
            
            const json = JSON.stringify(allData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `reporte-completo-${new Date().toISOString().split('T')[0]}.json`;
            link.href = url;
            link.click();
        }

        // Cargar al inicio
        loadReports();
    </script>
</body>
</html>
